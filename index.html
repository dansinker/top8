<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Top 8 Friends</title>

        <!-- External Dependencies -->
        <!-- Alpine.js must be first and defer -->
        <script src="//unpkg.com/alpinejs" defer></script>

        <!-- Supporting classes -->
        <script src="js/config.js"></script>
        <script src="js/auth.js"></script>
        <script src="js/profile.js"></script>
        <script src="js/storage.js"></script>
        <script src="js/posts.js"></script>
        <script src="js/pds.js"></script>
        <script src="js/themePDS.js"></script>
        <script src="js/top8.js"></script>

        <!-- Alpine integration must be last -->
        <script src="js/alpine-integration.js"></script>

        <!-- Styles -->
        <link rel="stylesheet" href="css/styles.css" />
    </head>

    <body x-data="theme()" :class="themeClass" class="default">
        <div id="wrapper">
            <!-- Logo Section -->
            <div id="logo">
                <img src="/images/logo.svg" />
            </div>

            <div id="wholething" x-data="appState" x-init="init">
                <!-- Left Column -->
                <div id="leftcolumn">
                    <!-- Login Form -->
                    <div id="addbox" class="box" x-show="!person.name">
                        <h1>Log in with Bluesky</h1>
                        <form @submit.prevent="loginUser">
                            <div class="form-group">
                                <label for="username">Username</label>
                                <input
                                    type="text"
                                    id="username"
                                    placeholder="username.bsky.social"
                                    x-model="username"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label for="password">Password</label>
                                <input
                                    type="password"
                                    id="password"
                                    placeholder="Your Bluesky password"
                                    x-model="password"
                                    required
                                />
                            </div>
                            <div
                                class="error-message"
                                x-show="loginError"
                                x-text="loginError"
                            ></div>
                            <button
                                type="submit"
                                :disabled="loading"
                                x-text="loading ? 'Logging in...' : 'Log in'"
                            ></button>
                        </form>
                    </div>

                    <!-- Profile Box -->
                    <div id="profilebox" class="box" x-show="person.name">
                        <h1><span x-text="person.name"></span></h1>
                        <p><img :src="person.avatar" :alt="person.name" /></p>
                        <h2>
                            <a :href="person.bsky_url" target="_blank"
                                ><span x-text="person.bsky_handle"></span
                            ></a>
                        </h2>
                        <p x-html="person.note"></p>
                        <button @click="logout">Logout</button>
                    </div>

                    <!-- Theme Selector -->
                    <div
                        id="editbox"
                        class="box"
                        x-data="theme()"
                        x-init="init()"
                    >
                        <h1>Choose Your Theme</h1>
                        <div class="color-theme-container">
                            <template
                                x-for="(ct, index) in colorThemes"
                                :key="index"
                            >
                                <span
                                    :class="choiceClass(ct)"
                                    @click="changeTheme(ct)"
                                    :title="ct"
                                >
                                </span>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div id="rightcolumn">
                    <!-- Friends List -->
                    <!-- Replace the entire top8box div with this corrected version -->
                    <div id="top8box" 
                         x-data="top8"
                         x-init="init()">
                        <h1>My Top <span x-text="friends.length"></span></h1>
                        
                        <!-- Add Friend Button -->
                        <button @click="showDialog = true; searchQuery = ''; searchResults = []"
                                class="edit-button"></button>
                            Edit Top 8
                        </button>
                    
                        <!-- Friends Grid -->
                        <div class="friends-grid">
                            <template x-for="friend in friends" :key="friend.did">
                                <div class="friend">
                                    <img :src="friend.avatar || '/api/placeholder/120/120'" 
                                         :alt="friend.displayName"/>
                                    <h2 x-text="friend.displayName"></h2>
                                    <a :href="'https://bsky.app/profile/' + friend.handle" 
                                       target="_blank" 
                                       x-text="friend.handle"></a>
                                </div>
                            </template>
                        </div>
                    
                        <!-- Friend Selection Dialog -->
                        <div x-show="showDialog" 
                             class="dialog-overlay"
                             @click="showDialog = false">
                            <div class="dialog-content box"
                                 @click.stop>
                                <h2>Select Your Top 8</h2>
                                
                                <!-- Current Selection Counter -->
                                <div class="selection-counter">
                                    Selected: <span x-text="selectedFriends.length"></span>/8
                                </div>
                    
                                <!-- Search Input -->
                                <div class="search-box">
                                    <input type="text"
                                           x-model="searchQuery"
                                           @input.debounce.500ms="searchFriends()"
                                           placeholder="Search friends..."
                                           :disabled="loading"/>
                                    
                                    <div x-show="loading" class="loading-indicator">
                                        <span>Loading all follows...</span>
                                        <div class="progress-note" x-show="followsCache">
                                            Searching across <span x-text="followsCache.length"></span> follows
                                        </div>
                                    </div>
                                </div>
                    
                                <!-- Error Message -->
                                <div x-show="error" 
                                     x-text="error"
                                     class="error-message"></div>
                    
                                <!-- Loading Message -->
                                <div x-show="loading" class="loading-message">
                                    <span>Searching...</span>
                                </div>
                    
                                <!-- Search Results -->
                                <div class="search-results" x-show="!loading">
                                    <template x-for="friend in searchResults" :key="friend.did">
                                        <div class="friend-item"
                                             :class="{ 'selected': isFriendSelected(friend) }"
                                             @click="toggleFriend(friend)">
                                            <img :src="friend.avatar || '/api/placeholder/40/40'" 
                                                 :alt="friend.displayName"
                                                 class="avatar"/>
                                            <div class="friend-info">
                                                <span class="name" x-text="friend.displayName"></span>
                                                <span class="handle" x-text="'@' + friend.handle"></span>
                                            </div>
                                            <div class="select-indicator"
                                                 x-show="isFriendSelected(friend)">
                                                âœ“
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <div x-show="searchQuery && !loading && !searchResults.length" 
                                         class="no-results">
                                        No friends found matching your search
                                    </div>
                                </div>
                    
                                <!-- Dialog Buttons -->
                                <div class="dialog-buttons">
                                    <button @click="showDialog = false" class="cancel-button">
                                        Cancel
                                    </button>
                                    <button @click="saveFriends()" 
                                            :disabled="loading"
                                            class="save-button">
                                        Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    

                    <!-- Posts Section -->
                    <!-- Replace the existing Posts Section in index.html with this: -->
                    <template x-if="person.bsky_handle">
                        <div id="postbox" x-data="posts">
                            <h1>My Latest Posts</h1>

                            <!-- Loading State -->
                            <div x-show="loading" class="loading">
                                Loading posts...
                            </div>

                            <!-- Error State -->
                            <div
                                x-show="error"
                                class="error"
                                x-text="error"
                            ></div>

                            <!-- Posts -->
                            <template x-for="blog in blogs" :key="blog.uri">
                                <div class="post">
                                    <p x-html="blog.text"></p>
                                    <div class="post-meta">
                                        <a
                                            :href="blog.author.url"
                                            target="_blank"
                                        >
                                            <span
                                                x-text="blog.author.name"
                                            ></span>
                                            (@<span
                                                x-text="blog.author.handle"
                                            ></span
                                            >)
                                        </a>
                                        <span
                                            x-text="new Date(blog.createdAt).toLocaleString()"
                                        ></span>
                                    </div>
                                </div>
                            </template>

                            <!-- No Posts State -->
                            <div
                                x-show="!loading && !error && blogs.length === 0"
                                class="no-posts"
                            >
                                No posts found
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </body>
</html>
