<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Top 8 Friends</title>

        <!-- External Dependencies -->
        <!-- Alpine.js -->
        <script
            defer
            src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
        ></script>

        <!-- Our class-based modules -->
        <script src="js/config.js"></script>
        <script src="js/auth.js"></script>
        <script src="js/profile.js"></script>
        <script src="js/storage.js"></script>
        <script src="js/theme.js"></script>

        <!-- Alpine.js integration -->
        <script src="js/alpine-integration.js"></script>

        <!-- Styles -->
        <link rel="stylesheet" href="css/styles.css" />
    </head>

    <body x-data="theme()" :class="themeClass" class="default">
        <div id="wrapper">
            <!-- Logo Section -->
            <div id="logo">
                <img src="/images/logo.svg" />
            </div>

            <div id="wholething" x-data="appState" x-init="init">
                <!-- Left Column -->
                <div id="leftcolumn">
                    <!-- Login Form -->
                    <div id="addbox" class="box" x-show="!person.name">
                        <h1>Log in with Bluesky</h1>
                        <form @submit.prevent="loginUser">
                            <div class="form-group">
                                <label for="username">Username</label>
                                <input
                                    type="text"
                                    id="username"
                                    placeholder="username.bsky.social"
                                    x-model="username"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label for="password">Password</label>
                                <input
                                    type="password"
                                    id="password"
                                    placeholder="Your Bluesky password"
                                    x-model="password"
                                    required
                                />
                            </div>
                            <div
                                class="error-message"
                                x-show="loginError"
                                x-text="loginError"
                            ></div>
                            <button
                                type="submit"
                                :disabled="loading"
                                x-text="loading ? 'Logging in...' : 'Log in'"
                            ></button>
                        </form>
                    </div>

                    <!-- Profile Box -->
                    <div id="profilebox" class="box" x-show="person.name">
                        <h1><span x-text="person.name"></span></h1>
                        <p><img :src="person.avatar" :alt="person.name" /></p>
                        <h2>
                            <a :href="person.bsky_url" target="_blank"
                                ><span x-text="person.bsky_handle"></span
                            ></a>
                        </h2>
                        <p x-html="person.note"></p>
                        <button @click="logout">Logout</button>
                    </div>

                    <!-- Theme Selector -->
                    <div
                        id="editbox"
                        class="box"
                        x-data="theme()"
                        x-init="init()"
                    >
                        <h1>Choose Your Theme</h1>
                        <div class="color-theme-container">
                            <template
                                x-for="(ct, index) in colorThemes"
                                :key="index"
                            >
                                <span
                                    :class="choiceClass(ct)"
                                    @click="changeTheme(ct)"
                                    :title="ct"
                                >
                                </span>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div id="rightcolumn">
                    <!-- Friends List -->
                    <div id="top8box" x-data="{ friends: [], newFriend: '' }">
                        <h1>My Top <span x-text="friends.length"></span></h1>
                        <form @submit.prevent="addFriend">
                            <label for="new-friend">Add a friend:</label>
                            <input
                                id="new-friend"
                                type="text"
                                x-model="newFriend"
                                placeholder="yourfriend.bsky.social"
                            />
                            <button type="submit">Add friend</button>
                        </form>

                        <!-- Friends Grid -->
                        <div class="friends-grid">
                            <template x-for="friend in friends">
                                <div
                                    class="friend"
                                    x-data="{ top8: {} }"
                                    x-init="fetch(`https://public.api.bsky.app/xrpc/app.bsky.actor.getProfile?actor=${friend}`)
                                    .then(response => response.ok ? response.json() : null)
                                    .then(data => {
                                        if (data) {
                                            top8 = {
                                                name: data.displayName || friend,
                                                bsky_handle: data.handle,
                                                bsky_url: `https://bsky.app/profile/${data.handle}`,
                                                avatar: data.avatar || '/default-avatar.png'
                                            };
                                        }
                                    })"
                                >
                                    <h2><span x-text="top8.name"></span></h2>
                                    <a :href="top8.bsky_url" target="_blank">
                                        <img
                                            :src="top8.avatar"
                                            :alt="top8.name"
                                        />
                                    </a>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Posts Section -->
                    <template x-if="person.bsky_handle">
                        <div
                            id="postbox"
                            x-data="{ blogs: [] }"
                            x-init="fetch(`https://public.api.bsky.app/xrpc/app.bsky.feed.getAuthorFeed?actor=${person.bsky_handle}&limit=12`)
                            .then(response => response.json())
                            .then(data => {
                                blogs = data.feed
                                    .filter(item => !item.post.record.reply && !item.post.record.repost)
                                    .map(item => ({
                                        text: item.post.record.text,
                                        createdAt: item.post.record.createdAt,
                                        author: {
                                            name: item.post.author.displayName || item.post.author.handle,
                                            handle: item.post.author.handle,
                                            url: `https://bsky.app/profile/${item.post.author.handle}`
                                        }
                                    }));
                            })"
                        >
                            <h1>My Latest Posts</h1>
                            <template x-for="blog in blogs" :key="blog.uri">
                                <div class="post">
                                    <p x-html="blog.text"></p>
                                    <div class="post-meta">
                                        <a
                                            :href="blog.author.url"
                                            target="_blank"
                                        >
                                            <span
                                                x-text="blog.author.name"
                                            ></span>
                                            (@<span
                                                x-text="blog.author.handle"
                                            ></span
                                            >)
                                        </a>
                                        <span
                                            x-text="new Date(blog.createdAt).toLocaleString()"
                                        ></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </body>
</html>
